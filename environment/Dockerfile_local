# ---------- Stage 1: Builder ----------
FROM tensorflow/tensorflow:2.11.0-gpu as builder

ARG DEBIAN_FRONTEND=noninteractive
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Install only essential system dependencies and Python 3.10
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        wget \
        git \
        software-properties-common && \
    add-apt-repository ppa:deadsnakes/ppa && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        python3.10 \
        python3.10-venv \
        python3.10-dev && \
    rm -rf /var/lib/apt/lists/*

# Create virtual environment with Python 3.10
RUN python3.10 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Install Python packages directly without Conda
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir \
        aind-large-scale-prediction==1.0.0 \
        aind-data-schema==1.0.0 \
        aind-ng-link==1.0.6 \
        psutil==5.9.8 \
        jupyter-server-proxy==3.2.2 \
        cellfinder>=1.0.0 \
        argschema \
        pandas \
        openpyxl \
        tensorflow-gpu==2.11.0

# ---------- Stage 2: Runtime ----------
FROM tensorflow/tensorflow:2.11.0-gpu-jupyter as runtime

LABEL maintainer="Camilo Laiton <camilo.laiton@alleninstitute.org>" \
        org.opencontainers.image.title="Image Cell Classification" \
        org.opencontainers.image.description="Container for cell classification in lightsheet images" \
        org.opencontainers.image.version="0.0.6" \
        org.opencontainers.image.licenses="MIT"

ARG DEBIAN_FRONTEND=noninteractive
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Install only runtime dependencies with Python 3.10
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        software-properties-common \
        git && \
    add-apt-repository ppa:deadsnakes/ppa && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        python3.10 \
        python3.10-distutils && \
    rm -rf /var/lib/apt/lists/*

# Copy only the built virtual environment from builder
COPY --from=builder /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Set working directory
WORKDIR /app

# Default command
CMD ["bash"]